<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCrop Market - Live Price Dashboard</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .hero-gradient { 
            background: linear-gradient(135deg, #0a2e1f 0%, #1a4d2e 50%, #2e7d5e 100%);
        }
        
        .card-hover { 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 25px 30px -12px rgba(0, 100, 0, 0.25);
        }
        
        .mono-font { font-family: 'JetBrains Mono', monospace; }
        
        .live-dot {
            width: 8px; height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 1.8s infinite;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafcfb 100%);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #16a34a, #86efac);
        }
        
        .chart-container {
            position: relative;
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
        }
        
        .price-table {
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        
        .price-table tbody tr {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }
        
        .price-table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 8px 20px -6px rgba(22, 163, 74, 0.2);
        }
        
        .chip-active {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: white;
            box-shadow: 0 4px 12px -4px #16a34a;
        }
        
        .gradient-border {
            position: relative;
            background: white;
            border-radius: 1rem;
        }
        
        .gradient-border::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #16a34a, #86efac, #4ade80);
            border-radius: 1.1rem;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .gradient-border:hover::before {
            opacity: 1;
        }
        
        .tooltip-custom {
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(4px);
            border-radius: 8px !important;
            padding: 8px 12px !important;
            font-family: 'JetBrains Mono', monospace !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>
<body class="min-h-screen">

<!-- Navigation -->
<nav class="hero-gradient shadow-xl fixed w-full z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
            <div class="flex items-center space-x-2">
                <i class="fas fa-seedling text-3xl text-white"></i>
                <span class="text-2xl font-bold text-white">Smart<span class="text-yellow-300">Crop</span></span>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                    <span class="live-dot"></span>
                    <span class="text-xs font-semibold text-white mono-font tracking-wider">LIVE MARKET</span>
                </div>
                <a href="index.html" class="px-6 py-2 bg-yellow-400 text-gray-900 font-bold rounded-lg hover:bg-yellow-300 transition shadow-lg flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Home
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="pt-32 pb-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header with Gradient -->
        <div class="relative mb-10">
            <div class="absolute inset-0 bg-gradient-to-r from-green-600/20 to-emerald-600/20 rounded-3xl blur-3xl"></div>
            <div class="relative bg-white/90 backdrop-blur rounded-3xl p-8 shadow-2xl border border-white/20">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-5xl font-extrabold">
                            <span class="bg-gradient-to-r from-green-700 to-emerald-600 bg-clip-text text-transparent">Market Price</span>
                            <span class="text-gray-900"> Board</span>
                        </h1>
                        <p class="text-gray-600 mt-3 mono-font text-sm flex items-center">
                            <i class="fas fa-clock text-green-600 mr-2"></i>
                            <span id="lastUpdated">Last updated: —</span>
                        </p>
                    </div>
                    <div class="flex space-x-3">
                        <div class="spinner hidden w-6 h-6 border-3 border-green-700 border-t-transparent rounded-full animate-spin" id="spinner"></div>
                        <button onclick="loadData()" class="px-5 py-2.5 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition flex items-center text-sm font-semibold">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                        <button onclick="fetchAndStore()" class="px-5 py-2.5 bg-gradient-to-r from-green-700 to-emerald-600 text-white rounded-xl hover:from-green-800 hover:to-emerald-700 transition flex items-center text-sm font-semibold shadow-lg shadow-green-600/30">
                            <i class="fas fa-download mr-2"></i>
                            Fetch Live Prices
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards with Modern Design -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <!-- Total Commodities -->
            <div class="stat-card rounded-2xl shadow-xl p-6 card-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-500 mono-font font-semibold tracking-wider">TOTAL COMMODITIES</p>
                        <p class="text-4xl font-extrabold text-gray-900 mt-3" id="totalCommodities">—</p>
                        <p class="text-xs text-gray-400 mt-2 flex items-center">
                            <i class="fas fa-chart-simple text-green-600 mr-1"></i>
                            tracked today
                        </p>
                    </div>
                    <div class="bg-gradient-to-br from-green-100 to-emerald-100 p-4 rounded-2xl">
                        <i class="fas fa-boxes text-2xl text-green-700"></i>
                    </div>
                </div>
            </div>

            <!-- Average Price -->
            <div class="stat-card rounded-2xl shadow-xl p-6 card-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-500 mono-font font-semibold tracking-wider">AVG MODAL PRICE</p>
                        <p class="text-4xl font-extrabold text-gray-900 mt-3" id="avgPrice">—</p>
                        <p class="text-xs text-gray-400 mt-2 flex items-center">
                            <i class="fas fa-weight-scale text-blue-600 mr-1"></i>
                            per quintal
                        </p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-100 to-indigo-100 p-4 rounded-2xl">
                        <i class="fas fa-chart-line text-2xl text-blue-700"></i>
                    </div>
                </div>
            </div>

            <!-- Highest Today -->
            <div class="stat-card rounded-2xl shadow-xl p-6 card-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-500 mono-font font-semibold tracking-wider">HIGHEST TODAY</p>
                        <p class="text-4xl font-extrabold text-green-600 mt-3" id="highestPrice">—</p>
                        <p class="text-xs text-gray-400 mt-2 flex items-center" id="highestCommodity">
                            <i class="fas fa-tag text-yellow-600 mr-1"></i>
                            —
                        </p>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-100 to-amber-100 p-4 rounded-2xl">
                        <i class="fas fa-arrow-up text-2xl text-yellow-700"></i>
                    </div>
                </div>
            </div>

            <!-- Lowest Today -->
            <div class="stat-card rounded-2xl shadow-xl p-6 card-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-500 mono-font font-semibold tracking-wider">LOWEST TODAY</p>
                        <p class="text-4xl font-extrabold text-red-600 mt-3" id="lowestPrice">—</p>
                        <p class="text-xs text-gray-400 mt-2 flex items-center" id="lowestCommodity">
                            <i class="fas fa-tag text-red-600 mr-1"></i>
                            —
                        </p>
                    </div>
                    <div class="bg-gradient-to-br from-red-100 to-rose-100 p-4 rounded-2xl">
                        <i class="fas fa-arrow-down text-2xl text-red-700"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Price Table & Chart -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Price Table Panel with Modern Design -->
                <div class="gradient-border rounded-2xl">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="px-8 py-6 bg-gradient-to-r from-gray-50 to-white border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-900 flex items-center text-lg">
                                <i class="fas fa-table text-green-700 mr-3 text-xl"></i>
                                Live Market Prices
                            </h3>
                            <span class="bg-gradient-to-r from-green-600 to-emerald-600 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg" id="recordCount">0 records</span>
                        </div>
                        <div class="p-6" id="priceTableContainer">
                            <div class="text-center py-16">
                                <i class="fas fa-seedling text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500 text-lg">No price data yet.</p>
                                <p class="text-gray-400 text-sm mt-2">Click "Fetch Live Prices" to load market data.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Chart - Enhanced Design -->
                <div class="gradient-border rounded-2xl">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="px-8 py-6 bg-gradient-to-r from-gray-50 to-white border-b">
                            <h3 class="font-bold text-gray-900 flex items-center text-lg">
                                <i class="fas fa-chart-line text-green-700 mr-3 text-xl"></i>
                                Price History
                            </h3>
                        </div>
                        <div class="p-8">
                            <!-- Commodity Chips with Better Design -->
                            <div class="flex flex-wrap gap-3 mb-8" id="commodityChips"></div>
                            
                            <!-- Chart Container with Fixed Height and Better Styling -->
                            <div class="relative h-[350px] w-full bg-gradient-to-b from-gray-50/50 to-white rounded-xl p-4">
                                <canvas id="historyChart" class="w-full h-full"></canvas>
                            </div>
                            
                            <!-- Chart Legend -->
                            <div class="flex justify-center items-center space-x-6 mt-6 text-xs">
                                <div class="flex items-center">
                                    <span class="w-3 h-3 bg-green-600 rounded-full mr-2"></span>
                                    <span class="text-gray-600 mono-font">Modal Price</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                                    <span class="text-gray-600 mono-font">Min Price</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                    <span class="text-gray-600 mono-font">Max Price</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Sidebar -->
            <div class="space-y-8">
                <!-- Today vs Yesterday -->
                <div class="gradient-border rounded-2xl">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="px-8 py-6 bg-gradient-to-r from-gray-50 to-white border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-900 flex items-center text-lg">
                                <i class="fas fa-balance-scale text-green-700 mr-3 text-xl"></i>
                                Today vs Yesterday
                            </h3>
                            <span class="bg-gradient-to-r from-yellow-500 to-amber-500 text-white text-xs font-bold px-4 py-2 rounded-full">COMPARISON</span>
                        </div>
                        <div class="divide-y max-h-[400px] overflow-y-auto custom-scrollbar" id="compareList">
                            <div class="p-12 text-center">
                                <i class="fas fa-chart-bar text-5xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">Fetch data to see comparison</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Distribution Donut -->
                <div class="gradient-border rounded-2xl">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="px-8 py-6 bg-gradient-to-r from-gray-50 to-white border-b">
                            <h3 class="font-bold text-gray-900 flex items-center text-lg">
                                <i class="fas fa-chart-pie text-green-700 mr-3 text-xl"></i>
                                Price Distribution
                            </h3>
                        </div>
                        <div class="p-8 flex justify-center items-center">
                            <div class="relative w-[300px] h-[300px]">
                                <canvas id="donutChart" class="w-full h-full"></canvas>
                            </div>
                        </div>
                        <div class="px-8 pb-6 text-center text-sm text-gray-500 mono-font">
                            Top 6 commodities by price
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-gray-900 text-white py-8 mt-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <p class="text-gray-400 text-sm">&copy; 2024 SmartCrop. All rights reserved. Market data for informational purposes.</p>
    </div>
</footer>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-6 right-6 bg-white shadow-2xl rounded-xl px-6 py-4 border-l-4 border-green-600 transform translate-y-20 opacity-0 transition-all duration-300 z-50 backdrop-blur"></div>

<style>
/* Custom Scrollbar */
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #16a34a;
    border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #15803d;
}

/* Chart Tooltip */
.chartjs-tooltip {
    background: rgba(0, 0, 0, 0.8) !important;
    backdrop-filter: blur(4px);
    border-radius: 8px !important;
    padding: 8px 12px !important;
    font-family: 'JetBrains Mono', monospace !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: white !important;
}
</style>

<script>
// ── State ────────────────────────────────────────────────────────────────────
let latestPrices = [];
let historyChart = null;
let donutChart   = null;
let selectedCommodity = 'Tomato';

const COMMODITIES = ['Tomato', 'Onion', 'Potato', 'Rice', 'Wheat', 'Maize', 'Garlic', 'Ginger', 'Chilli', 'Brinjal'];

// ── Mock API Functions ────────────────────────────────────────────────────────
function api(path, method = 'GET') {
    return new Promise((resolve) => {
        setTimeout(() => {
            if (path === '/api/prices/latest') {
                resolve({
                    data: [
                        { commodity: 'Tomato', modal_price: 3200, min_price: 2800, max_price: 3500, unit: 'per Quintal', market: 'Azadpur', source: 'Live' },
                        { commodity: 'Potato', modal_price: 2800, min_price: 2400, max_price: 3000, unit: 'per Quintal', market: 'Azadpur', source: 'Live' },
                        { commodity: 'Onion', modal_price: 4200, min_price: 3800, max_price: 4500, unit: 'per Quintal', market: 'Lasalgaon', source: 'Live' },
                        { commodity: 'Rice', modal_price: 3800, min_price: 3400, max_price: 4100, unit: 'per Quintal', market: 'Karnal', source: 'Live' },
                        { commodity: 'Wheat', modal_price: 2500, min_price: 2200, max_price: 2700, unit: 'per Quintal', market: 'Punjab', source: 'Live' },
                        { commodity: 'Maize', modal_price: 2100, min_price: 1800, max_price: 2300, unit: 'per Quintal', market: 'UP', source: 'Live' },
                        { commodity: 'Garlic', modal_price: 8500, min_price: 7800, max_price: 9200, unit: 'per Quintal', market: 'MP', source: 'Simulated' },
                        { commodity: 'Ginger', modal_price: 11200, min_price: 9800, max_price: 12500, unit: 'per Quintal', market: 'Kerala', source: 'Simulated' }
                    ]
                });
            } else if (path === '/api/prices/compare') {
                resolve({
                    data: [
                        { commodity: 'Tomato', today_price: 3200, yesterday_price: 3000, trend: 'up', pct_change: 6.7 },
                        { commodity: 'Potato', today_price: 2800, yesterday_price: 2900, trend: 'down', pct_change: -3.4 },
                        { commodity: 'Onion', today_price: 4200, yesterday_price: 4000, trend: 'up', pct_change: 5.0 },
                        { commodity: 'Rice', today_price: 3800, yesterday_price: 3750, trend: 'up', pct_change: 1.3 },
                        { commodity: 'Wheat', today_price: 2500, yesterday_price: 2550, trend: 'down', pct_change: -2.0 },
                        { commodity: 'Maize', today_price: 2100, yesterday_price: 2100, trend: 'flat', pct_change: 0 }
                    ]
                });
            } else if (path.includes('/api/prices/history')) {
                const commodity = path.split('=')[1].split('&')[0];
                const history = [];
                const basePrice = {
                    'Tomato': 3000,
                    'Potato': 2700,
                    'Onion': 4000,
                    'Rice': 3600,
                    'Wheat': 2400,
                    'Maize': 2000
                }[commodity] || 3000;
                
                for (let i = 30; i > 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    
                    // Create smooth trending data
                    const trend = Math.sin(i / 5) * 200;
                    const volatility = Math.random() * 100;
                    
                    history.push({
                        created_at: date.toISOString(),
                        modal_price: basePrice + trend + volatility,
                        min_price: basePrice + trend - 200 + volatility * 0.5,
                        max_price: basePrice + trend + 300 + volatility * 0.5
                    });
                }
                resolve({ data: history });
            } else if (path === '/api/prices/fetch' && method === 'POST') {
                resolve({ status: 'success', count: 8, message: 'Fetched successfully' });
            }
        }, 500);
    });
}

function showSpinner(on) {
    document.getElementById('spinner').style.display = on ? 'block' : 'none';
}

function toast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `fixed bottom-6 right-6 bg-white shadow-2xl rounded-xl px-6 py-4 border-l-4 ${type === 'success' ? 'border-green-600' : 'border-red-600'} transform translate-y-0 opacity-100 transition-all duration-300 z-50 backdrop-blur`;
    setTimeout(() => t.className = 'fixed bottom-6 right-6 bg-white shadow-2xl rounded-xl px-6 py-4 border-l-4 border-green-600 transform translate-y-20 opacity-0 transition-all duration-300 z-50 backdrop-blur', 3000);
}

// ── Fetch & Store ─────────────────────────────────────────────────────────────
async function fetchAndStore() {
    showSpinner(true);
    try {
        const data = await api('/api/prices/fetch', 'POST');
        if (data.status === 'success') {
            toast(`✓ Fetched & stored ${data.count} price records`);
            await loadData();
        } else {
            toast('✗ ' + (data.message || 'Failed'), 'error');
        }
    } catch(e) {
        toast('✗ Server error: ' + e.message, 'error');
    }
    showSpinner(false);
}

// ── Load All Data ─────────────────────────────────────────────────────────────
async function loadData() {
    showSpinner(true);
    try {
        const [priceRes, compareRes] = await Promise.all([
            api('/api/prices/latest'),
            api('/api/prices/compare')
        ]);
        latestPrices = priceRes.data || [];
        renderPriceTable(latestPrices);
        renderStats(latestPrices);
        renderComparison(compareRes.data || []);
        renderDonut(latestPrices);
        renderChips();
        loadHistory(selectedCommodity);
        document.getElementById('lastUpdated').textContent =
            'Last updated: ' + new Date().toLocaleTimeString() + ' IST';
    } catch(e) {
        toast('✗ Load failed: ' + e.message, 'error');
    }
    showSpinner(false);
}

// ── Stats ─────────────────────────────────────────────────────────────────────
function renderStats(prices) {
    if (!prices.length) return;
    const modals = prices.map(p => p.modal_price).filter(Boolean);
    const avg    = modals.reduce((a,b) => a+b, 0) / modals.length;
    const maxP   = prices.reduce((a,b) => b.modal_price > a.modal_price ? b : a);
    const minP   = prices.reduce((a,b) => b.modal_price < a.modal_price ? b : a);

    document.getElementById('totalCommodities').textContent = prices.length;
    document.getElementById('avgPrice').textContent         = '₹' + Math.round(avg).toLocaleString('en-IN');
    document.getElementById('highestPrice').textContent     = '₹' + Math.round(maxP.modal_price).toLocaleString('en-IN');
    document.getElementById('highestCommodity').innerHTML   = '<i class="fas fa-tag text-yellow-600 mr-1"></i>' + maxP.commodity;
    document.getElementById('lowestPrice').textContent      = '₹' + Math.round(minP.modal_price).toLocaleString('en-IN');
    document.getElementById('lowestCommodity').innerHTML    = '<i class="fas fa-tag text-red-600 mr-1"></i>' + minP.commodity;
}

// ── Price Table ───────────────────────────────────────────────────────────────
function renderPriceTable(prices) {
    const container = document.getElementById('priceTableContainer');
    document.getElementById('recordCount').textContent = prices.length + ' records';

    if (!prices.length) {
        container.innerHTML = `<div class="text-center py-16"><i class="fas fa-seedling text-6xl text-gray-300 mb-4"></i><p class="text-gray-500 text-lg">No price data yet.</p><p class="text-gray-400 text-sm mt-2">Click "Fetch Live Prices" to load market data.</p></div>`;
        return;
    }

    const rows = prices.map(p => {
        const sourceClass = p.source && p.source.includes('Simulated') 
            ? 'bg-yellow-100 text-yellow-700' 
            : 'bg-green-100 text-green-700';
        return `
            <tr onclick="selectCommodity('${p.commodity}')" class="hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 cursor-pointer transition-all rounded-xl" style="cursor: pointer;">
                <td class="px-4 py-4">
                    <div class="font-bold text-gray-900 text-base">${p.commodity}</div>
                    <div class="mt-1.5"><span class="${sourceClass} text-xs px-3 py-1.5 rounded-full font-semibold">${p.source || 'LIVE'}</span></div>
                </td>
                <td class="px-4 py-4 font-mono font-extrabold text-green-700 text-lg">₹${Math.round(p.modal_price).toLocaleString('en-IN')}</td>
                <td class="px-4 py-4 font-mono text-gray-600">₹${Math.round(p.min_price||0).toLocaleString('en-IN')} – ₹${Math.round(p.max_price||0).toLocaleString('en-IN')}</td>
                <td class="px-4 py-4 text-gray-600 font-medium">${p.unit || 'per Quintal'}</td>
                <td class="px-4 py-4 text-gray-600 font-medium">${p.market || '—'}</td>
            </tr>`;
    }).join('');

    container.innerHTML = `
        <div class="overflow-x-auto">
            <table class="w-full price-table">
                <thead>
                    <tr class="text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                        <th class="px-4 py-3">Commodity</th>
                        <th class="px-4 py-3">Modal Price</th>
                        <th class="px-4 py-3">Range</th>
                        <th class="px-4 py-3">Unit</th>
                        <th class="px-4 py-3">Market</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    ${rows}
                </tbody>
            </table>
        </div>`;
}

// ── Comparison ────────────────────────────────────────────────────────────────
function renderComparison(data) {
    const el = document.getElementById('compareList');
    if (!data.length) {
        el.innerHTML = `<div class="p-12 text-center"><i class="fas fa-chart-bar text-5xl text-gray-300 mb-4"></i><p class="text-gray-500">Need 2 days of data for comparison</p></div>`;
        return;
    }

    el.innerHTML = data.map(d => {
        const arrow = d.trend === 'up' ? '↑' : d.trend === 'down' ? '↓' : '→';
        const colorClass = d.trend === 'up' ? 'text-green-700 bg-green-100' : d.trend === 'down' ? 'text-red-700 bg-red-100' : 'text-gray-700 bg-gray-100';
        const pct = d.pct_change ? `${d.pct_change > 0 ? '+' : ''}${d.pct_change.toFixed(1)}%` : '—';
        return `
            <div class="p-5 hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 transition">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-extrabold text-gray-900 text-lg">${d.commodity}</h4>
                        <p class="text-sm text-gray-600 mt-1.5 flex items-center">
                            <i class="fas fa-calendar-day text-green-600 mr-1.5"></i>
                            Today: ₹${d.today_price ? Math.round(d.today_price).toLocaleString('en-IN') : '—'}
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold ${colorClass}">
                            ${arrow} ${pct}
                        </span>
                        <p class="text-sm text-gray-500 mt-2 flex items-center">
                            <i class="fas fa-calendar text-gray-400 mr-1.5"></i>
                            Prev: ₹${d.yesterday_price ? Math.round(d.yesterday_price).toLocaleString('en-IN') : '—'}
                        </p>
                    </div>
                </div>
            </div>`;
    }).join('');
}

// ── Commodity Chips ───────────────────────────────────────────────────────────
function renderChips() {
    const available = latestPrices.map(p => p.commodity);
    const chips = available.length ? available : COMMODITIES;
    document.getElementById('commodityChips').innerHTML = chips.map(c => `
        <button onclick="selectCommodity('${c}')" class="px-5 py-2.5 rounded-full text-xs font-bold transition-all duration-300 transform hover:scale-105 ${c === selectedCommodity ? 'chip-active shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
            ${c}
        </button>
    `).join('');
}

function selectCommodity(c) {
    selectedCommodity = c;
    renderChips();
    loadHistory(c);
}

// ── History Chart ─────────────────────────────────────────────────────────────
async function loadHistory(commodity) {
    try {
        const res = await api(`/api/prices/history?commodity=${commodity}&limit=20`);
        const data = res.data || [];
        renderHistoryChart(commodity, data);
    } catch(e) { console.error(e); }
}

function renderHistoryChart(commodity, data) {
    const ctx = document.getElementById('historyChart').getContext('2d');
    if (historyChart) historyChart.destroy();

    const labels = data.map(d => {
        const dt = new Date(d.created_at);
        return dt.toLocaleDateString('en-IN', { day:'2-digit', month:'short' });
    });
    const modals = data.map(d => d.modal_price);
    const mins   = data.map(d => d.min_price);
    const maxs   = data.map(d => d.max_price);

    // Create gradient backgrounds
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(22, 163, 74, 0.2)');
    gradient.addColorStop(1, 'rgba(22, 163, 74, 0)');

    historyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Modal Price',
                    data: modals,
                    borderColor: '#16a34a',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#16a34a',
                    pointBorderColor: 'white',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#16a34a',
                    pointHoverBorderColor: 'white',
                    pointHoverBorderWidth: 3,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Min Price',
                    data: mins,
                    borderColor: '#94a3b8',
                    borderDash: [5,5],
                    borderWidth: 2,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'Max Price',
                    data: maxs,
                    borderColor: '#ef4444',
                    borderDash: [5,5],
                    borderWidth: 2,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    tension: 0.3,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'rgba(255, 255, 255, 0.8)',
                    bodyFont: {
                        family: 'JetBrains Mono'
                    },
                    padding: 12,
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += '₹' + context.parsed.y.toLocaleString('en-IN');
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#64748b',
                        font: {
                            family: 'JetBrains Mono',
                            size: 10
                        },
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#64748b',
                        font: {
                            family: 'JetBrains Mono',
                            size: 10
                        },
                        callback: function(value) {
                            return '₹' + value.toLocaleString('en-IN');
                        }
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.3
                }
            }
        }
    });
}

// ── Donut Chart ───────────────────────────────────────────────────────────────
function renderDonut(prices) {
    const ctx = document.getElementById('donutChart').getContext('2d');
    if (donutChart) donutChart.destroy();
    if (!prices.length) return;

    const sorted = [...prices].sort((a, b) => b.modal_price - a.modal_price);
    const labels = sorted.slice(0, 6).map(p => p.commodity);
    const vals   = sorted.slice(0, 6).map(p => p.modal_price);
    const colors = [
        '#16a34a', '#22c55e', '#4ade80', '#86efac', '#bbf7d0', '#dcfce7'
    ];

    donutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data: vals,
                backgroundColor: colors,
                borderColor: '#ffffff',
                borderWidth: 4,
                hoverOffset: 10
            }]
        },
        options: {
            cutout: '70%',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#4b5563',
                        font: {
                            family: 'Inter',
                            size: 11,
                            weight: '500'
                        },
                        padding: 16,
                        boxWidth: 12,
                        boxHeight: 12
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'rgba(255, 255, 255, 0.8)',
                    bodyFont: {
                        family: 'JetBrains Mono'
                    },
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return ` ₹${Math.round(value).toLocaleString('en-IN')} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// ── Init ──────────────────────────────────────────────────────────────────────
loadData();
setInterval(loadData, 5 * 60 * 1000);
</script>
</body>
</html>
