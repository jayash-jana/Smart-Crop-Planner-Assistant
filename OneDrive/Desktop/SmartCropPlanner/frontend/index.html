<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Crop Planner - ML Powered</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">

<!-- Navigation -->
<nav class="bg-white shadow-lg fixed w-full z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
            <div class="flex items-center space-x-2">
                <i class="fas fa-seedling text-3xl text-green-600"></i>
                <span class="text-2xl font-bold text-gray-800">Smart<span class="text-green-600">Crop</span></span>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="pt-24 pb-12 px-4 max-w-7xl mx-auto">

    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">üåæ ML-Powered Crop Planner</h1>
        <p class="text-gray-600 mt-1">Enter your farm details for AI-based crop recommendations</p>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="mb-4"></div>

    <!-- Two Column Layout -->
    <div class="grid lg:grid-cols-2 gap-8">
        
        <!-- LEFT: INPUT FORM -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-clipboard-list bg-green-100 p-3 rounded-lg text-green-600 mr-3"></i>
                Farm Details
            </h2>
            
            <!-- IMPORTANT: The form ID must match what JavaScript expects -->
            <form id="cropPlannerForm" class="space-y-6">
                
                <!-- Soil Parameters -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Nitrogen (N)</label>
                        <input type="number" id="nitrogen" name="nitrogen" value="80" step="1" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Phosphorus (P)</label>
                        <input type="number" id="phosphorus" name="phosphorus" value="40" step="1" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Potassium (K)</label>
                        <input type="number" id="potassium" name="potassium" value="40" step="1" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Soil pH</label>
                        <input type="number" id="ph" name="ph" value="6.5" step="0.1" min="0" max="14" class="w-full p-3 border rounded-lg" required>
                    </div>
                </div>
                
                <!-- Weather Parameters -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Temperature (¬∞C)</label>
                        <input type="number" id="temperature" name="temperature" value="25" step="0.1" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Humidity (%)</label>
                        <input type="number" id="humidity" name="humidity" value="70" step="1" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Rainfall (mm)</label>
                        <input type="number" id="rainfall" name="rainfall" value="200" step="10" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Land Size (acres)</label>
                        <input type="number" id="landSize" name="landSize" value="10" step="0.5" class="w-full p-3 border rounded-lg" required>
                    </div>
                </div>
                
                <!-- Budget -->
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Budget (‚Çπ)</label>
                    <input type="number" id="budget" name="budget" value="200000" step="10000" class="w-full p-3 border rounded-lg" required>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-green-800 transition shadow-lg">
                    <i class="fas fa-robot mr-2"></i>
                    Generate ML Recommendations
                </button>
            </form>
        </div>
        
        <!-- RIGHT: RESULTS SECTION -->
        <div id="resultsSection" class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Results will be displayed here -->
            <div class="text-center text-gray-500">
                <i class="fas fa-chart-pie text-5xl text-gray-300 mb-4"></i>
                <p>Enter farm details and click Generate</p>
                <p class="text-xs mt-2">ML model will recommend best crops</p>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
// ============================================
// WORKING JAVASCRIPT - COPY THIS EXACTLY
// ============================================

const API_BASE = 'http://127.0.0.1:5000';

// Check connection on page load
async function checkConnection() {
    const statusDiv = document.getElementById('connectionStatus');
    
    try {
        const response = await fetch(`${API_BASE}/test`);
        if (response.ok) {
            const data = await response.json();
            statusDiv.innerHTML = `
                <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded">
                    <i class="fas fa-check-circle mr-2"></i>
                    ‚úÖ Connected to ML Backend | Model: ${data.model_loaded ? 'Ready' : 'Loading'}
                </div>
            `;
            return true;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                ‚ùå Cannot connect to backend. Make sure server is running on port 5000
            </div>
        `;
        return false;
    }
}

// Handle form submission
document.getElementById('cropPlannerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loading
    document.getElementById('resultsSection').innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-circle-notch fa-spin text-4xl text-green-600 mb-4"></i>
            <p class="text-gray-600">ML model is analyzing your farm data...</p>
            <p class="text-xs text-gray-400 mt-2">Using Random Forest Classifier</p>
        </div>
    `;
    
    // Get form data
    const formData = {
        nitrogen: parseFloat(document.getElementById('nitrogen').value),
        phosphorus: parseFloat(document.getElementById('phosphorus').value),
        potassium: parseFloat(document.getElementById('potassium').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        humidity: parseFloat(document.getElementById('humidity').value),
        ph: parseFloat(document.getElementById('ph').value),
        rainfall: parseFloat(document.getElementById('rainfall').value),
        total_land: parseFloat(document.getElementById('landSize').value),
        budget: parseFloat(document.getElementById('budget').value)
    };
    
    console.log('Sending data:', formData); // Debug
    
    try {
        // STEP 1: Get crop predictions
        const predictResponse = await fetch(`${API_BASE}/predict`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (!predictResponse.ok) {
            throw new Error(`HTTP error! status: ${predictResponse.status}`);
        }
        
        const predictData = await predictResponse.json();
        console.log('Prediction received:', predictData);
        
        // STEP 2: Show results
        displayResults(predictData, formData);
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('resultsSection').innerHTML = `
            <div class="text-center py-8 text-red-600">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p class="font-bold">Error occurred</p>
                <p class="text-sm mt-2">${error.message}</p>
                <button onclick="window.location.reload()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">
                    Try Again
                </button>
            </div>
        `;
    }
});

function displayResults(predictData, formData) {
    const crops = predictData.recommended_crops;
    const probabilities = predictData.probabilities;
    
    let html = `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold">üåæ ML Recommendations</h3>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">
                    Random Forest Model
                </span>
            </div>
            
            <!-- Crop Cards -->
            <div class="space-y-4">
    `;
    
    crops.forEach((crop, index) => {
        const confidence = (probabilities[index] * 100).toFixed(1);
        const colors = ['bg-green-50 border-green-500', 'bg-blue-50 border-blue-500', 'bg-yellow-50 border-yellow-500'];
        
        html += `
            <div class="${colors[index]} border-l-4 p-4 rounded-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="text-2xl font-bold">${index + 1}.</span>
                        <span class="text-xl font-semibold ml-2">${crop}</span>
                    </div>
                    <span class="text-lg font-bold text-green-600">${confidence}%</span>
                </div>
                <div class="w-full bg-gray-200 h-2 rounded-full mt-2">
                    <div class="bg-green-600 h-2 rounded-full" style="width: ${confidence}%"></div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
            
            <!-- Farm Summary -->
            <div class="bg-gray-50 p-4 rounded-lg mt-4">
                <h4 class="font-semibold mb-2">üìä Your Farm Summary</h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>Land Size: ${formData.total_land} acres</div>
                    <div>Budget: ‚Çπ${formData.budget.toLocaleString()}</div>
                    <div>Soil pH: ${formData.ph}</div>
                    <div>Temperature: ${formData.temperature}¬∞C</div>
                </div>
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-4">
                ${predictData.message || 'ML prediction successful'}
            </p>
        </div>
    `;
    
    document.getElementById('resultsSection').innerHTML = html;
}

// Check connection when page loads
window.onload = function() {
    checkConnection();
};
</script>

<!-- Footer -->
<footer class="bg-gray-900 text-white py-8 mt-12">
    <div class="max-w-7xl mx-auto px-4 text-center text-gray-400 text-sm">
        <p>¬© 2024 SmartCrop - ML Powered Farming Assistant</p>
    </div>
</footer>

</body>
</html>